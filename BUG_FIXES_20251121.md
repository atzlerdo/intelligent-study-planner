# Bug Fixes - 2025-11-21

## Summary
Fixed 2 critical bugs discovered during user testing related to session attendance tracking and data persistence.

**UPDATE 2025-11-22**: Added automatic data integrity check on page load to ensure database values always match what the user sees in the UI. See `DATA_INTEGRITY_FIX_20251122.md` for full details.

---

## Bug 3: Sessions Losing Course Assignment and Attendance Status (DATA LOSS)
**Status:** âœ… FIXED

### Problem
Sessions would lose their course assignment (`courseId`) and attendance data (`completed`, `completionPercentage`) after approximately 4 minutes. This happened consistently during auto-sync.

### Root Cause
When syncing with Google Calendar, the app would receive session data from Google and completely replace local sessions with the synced version. However, Google Calendar doesn't store app-specific fields like:
- `completed` (boolean - attendance tracking)
- `completionPercentage` (number - partial attendance)

These fields would be lost when the synced version replaced the local version.

### Fix Location
`src/App.tsx`, lines 1520-1533

### Fix Implementation
Instead of directly using the synced session, we now merge the synced scheduling data with local attendance data:

```typescript
// OLD CODE (Bug):
console.log(`âœ… Using synced version of ${id}`);
// Implicitly uses syncedSession, losing local fields

// NEW CODE (Fixed):
const merged = {
  ...syncedSession,  // Scheduling data from Google (authoritative)
  completed: currentSession.completed,  // Attendance (local only)
  completionPercentage: currentSession.completionPercentage,  // Partial attendance
};
console.log(`âœ… Using synced version of ${id} (preserving local attendance data)`);
sessionById.set(id, merged);
```

### Testing Steps
1. Hard refresh browser (Ctrl+Shift+R) to load the fix
2. Create sessions and mark them as attended with course assignments
3. Wait 5+ minutes for auto-sync to run
4. Verify sessions retain both:
   - Course assignment
   - Attendance status
   - Completion percentage

---

## Bug 2: Progress Bar Not Updating Completed Hours
**Status:** âœ… FIXED

### Problem
When marking unassigned past sessions as attended and assigning them to a course, the hours would disappear from the "scheduled" (yellow) bar but not appear in the "completed" (green) bar. The hours seemed to vanish.

### Root Cause
The `handleSessionFeedback` function was updating `completedHours` only in local React state (optimistic UI), but never persisting the change to the backend. When the app refreshed data from the backend, the old `completedHours` value would return, causing the update to be lost.

Workflow before fix:
1. User marks session attended â†’ `completedHours` updated in local state
2. Session updated on backend with `completed: true`
3. App fetches fresh data from backend
4. Backend still has old `completedHours` â†’ local update overwritten

### Fix Location
`src/App.tsx`, lines 848-897 (complete rewrite of `handleSessionFeedback`)

### Fix Implementation
Now we update the course's `completedHours` on the backend BEFORE refreshing data:

```typescript
// 1. Update session attendance
await apiUpdateSession(feedbackSession.id, payload);

// 2. Update course completedHours on backend (NEW!)
if (targetCourseId && feedback.completed) {
  const targetCourse = courses.find(c => c.id === targetCourseId);
  if (targetCourse) {
    const newCompletedHours = targetCourse.completedHours + feedback.completedHours;
    const newProgress = Math.min(Math.round((newCompletedHours / targetCourse.estimatedHours) * 100), 100);
    
    await apiUpdateCourse(targetCourseId, {
      completedHours: newCompletedHours,
      progress: newProgress,
    });
  }
}

// 3. Now fetch fresh data (completedHours already updated on backend)
const [freshCourses, freshSessions] = await Promise.all([apiGetCourses(), apiGetSessions()]);
```

### Key Changes
- **Before**: Optimistic UI only (local state update)
- **After**: Backend persistence THEN fetch fresh data
- **Result**: Progress bar correctly shows hours moving from "scheduled" â†’ "completed"

### Enhanced Logging
Added console logging to show when course hours are updated:
```
ðŸ“ˆ Updating course course-123 completedHours on backend: {
  old: 10,
  added: 2.5,
  new: 12.5,
  progress: 15
}
```

### Testing Steps
1. Hard refresh browser (Ctrl+Shift+R) to load the fix
2. Create an unassigned past session (e.g., 2 hours yesterday)
3. Mark it as attended and assign to a course
4. Verify progress bar shows:
   - Green "completed" bar grows by 2 hours
   - Yellow "scheduled" bar shrinks (if session was planned)
5. Refresh page and verify hours persist correctly

---

## Backend Support
Both fixes rely on the backend's support for extended fields in the course update endpoint:

### Supported Fields (`server/src/routes/courses.ts`, line 25)
- `completedHours` â†’ `completed_hours` (database)
- `scheduledHours` â†’ `scheduled_hours` (database)
- `progress` â†’ `progress` (database)
- `status` â†’ `status` (database)

These fields are validated and persisted in the `PUT /api/courses/:id` endpoint (lines 164-177).

---

## Remaining Bugs
Still to be investigated:

### Bug 1: Cannot Mark Unassigned Sessions as "Not Attended"
**Status:** ðŸ”§ TODO

User description: "I can not let a session as not attended anymore. It was that way, that the user clicked on a unassigned session from the past and said no, i did not attend. If the session could not be moved into another planned unassigned session the session was about to gray out."

**Next Steps:**
- Investigate session attendance dialog for unassigned sessions
- Check if dialog shows correctly for past unassigned sessions
- Verify "not attended" workflow and session gray-out logic

---

### Bug 4: Progress Bar Empties When Creating Unassigned Sessions
**Status:** ðŸ”§ TODO

User description: "When creating not study sessions without assigning them to a course the progress bar updated weirdly. After each creation of a new session without assignment the progress bar gets emptied out and then gets 4 hours back."

**Likely Cause:** May be related to Bug 2 fix (hours recalculation)

**Next Steps:**
- Test creating unassigned sessions after Bug 2 fix deployed
- May be automatically fixed by proper hours persistence
- Check if `scheduledHours` calculation includes unassigned sessions

---

### Bug 5: Race Condition During Sync
**Status:** ðŸ”§ TODO

User description: "I created in the app on 18.11 and 19.11. While the sync I created in the google calendar on 22.11 and 21. The 22.11 sessions has been removed during the sync."

**Root Cause Hypothesis:** 
When user creates event in Google Calendar while app is syncing, app sees event not in local state and may treat it as "should be deleted."

**Next Steps:**
- Investigate merge logic in `googleCalendar.ts` (lines 1475-1493)
- Check if sync properly handles "new during sync" events
- May need sync lock or better handling of concurrent creates

---

## Files Modified
1. **src/App.tsx**
   - Lines 1520-1533: Bug 3 fix (preserve local attendance data during sync)
   - Lines 848-897: Bug 2 fix (persist completedHours to backend)
   - Enhanced logging throughout merge and feedback flows

2. **ENHANCED_LOGGING_GUIDE.md** (created earlier)
   - Documentation of all logging patterns
   - Troubleshooting guide for sync issues

---

## Testing Checklist
- [ ] Bug 3: Sessions retain attendance after sync
- [ ] Bug 2: Progress bar updates correctly when marking attended
- [ ] Bug 2: Hours persist after page refresh
- [ ] Bug 3: No data loss after 5+ minutes of auto-sync
- [ ] Check enhanced logging shows proper field preservation
- [ ] Verify milestones still update correctly
- [ ] Test with both assigned and unassigned sessions

---

## Notes for User
**IMPORTANT:** You must hard refresh your browser (Ctrl+Shift+R / Cmd+Shift+R) to load the fixes!

The enhanced logging from previous session is still active, so you'll see detailed merge information in the console during testing.

If you discover any issues with these fixes, please provide:
1. Fresh browser console logs
2. Steps to reproduce the issue
3. Expected vs actual behavior
